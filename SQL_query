-- Compare the total revenue generated by Atliqo before and after 5G implementation. Include a percentage change in revenue.

WITH cte1 AS 
	(SELECT _before_after_5g, ROUND(SUM(atliqo_revenue_crores),2) AS REV
	FROM fact_atliqo_metrics AM
	JOIN dim_date DD ON
	DD.date = AM.date
	GROUP BY _before_after_5g)
SELECT b5.REV AS Rev_befor_5G, a5.REV AS Rev_After_5G, ROUND((a5.REV-b5.REV)*100/ b5.REV,3) AS Per_Change
FROM cte1 b5
JOIN 
cte1 a5 
WHERE 
b5._before_after_5g = "Before 5G"
AND
a5._before_after_5g = "After 5G"
;

-- Identify the top 5 cities contributing the highest revenue for Atliqo across all time periods.

 SELECT city_name, ROUND(SUM(atliqo_revenue_crores),2) AS REV
 FROM fact_atliqo_metrics AM
 JOIN dim_cities DC ON
 DC.city_code = AM.city_code
 GROUP BY city_name
 ORDER BY REV DESC
 LIMIT 5
 ;
 
 -- Calculate Atliqo's average market share percentage across all cities.
 

SELECT DC.city_code, city_name, ROUND(AVG(ms_pct),2) AS Market_shares
    FROM fact_market_share MS 
	JOIN dim_cities DC ON
	DC.city_code = MS.city_code
    WHERE company = 'Atliqo'
	GROUP BY DC.city_code, city_name
    ORDER BY Market_shares DESC ;


-- Calculate the month-over-month growth rate in revenue for Atliqo across all cities.

WITH Total_REV AS
	(SELECT date, DATE_FORMAT(date, "%b") AS month, ROUND(SUM(atliqo_revenue_crores),2) AS Total_Rev
	FROM fact_atliqo_metrics
	GROUP BY date
	ORDER BY date )
SELECT *, LAG(Total_Rev) OVER(ORDER BY date) AS Previous_Month_Rev, ROUND(((Total_Rev/LAG(Total_Rev) OVER(ORDER BY date))-1)*100,2) AS MOM_Growth_rate
FROM Total_REV
ORDER BY date ;

-- Determine the revenue contribution of each internet plan and rank them.

WITH cte1 AS
(SELECT plans, ROUND(SUM(plan_revenue_crores),2) AS Total_Rev
FROM fact_plan_revenue 
GROUP BY plans)
SELECT *, ROUND(Total_Rev*100/SUM(Total_Rev) OVER(),2) AS Rev_contribution, RANK() OVER(ORDER BY Total_Rev DESC) AS Ranking
FROM cte1
ORDER BY Total_Rev DESC
;

-- Identify the top 3 and bottom 3 cities based on ARPU (average revenue per user).

WITH cte1 AS
(SELECT city_name, AVG(arpu) AS AVG_Rev_Per_User, RANK() OVER(ORDER BY AVG(arpu) DESC) AS T3, RANK() OVER(ORDER BY AVG(arpu) ASC) AS  B3
FROM  fact_atliqo_metrics AM
JOIN
dim_cities DC ON
AM.city_code = DC.city_code
GROUP BY city_name)
SELECT city_name, AVG_Rev_Per_User
FROM cte1 
WHERE 
	T3 < 4
    OR
    B3 < 4
ORDER BY AVG_Rev_Per_User DESC ;

-- Compare Atliqo's market share before and after 5G implementation. Highlight the top 3 cities where Atliqo saw the most improvement.

WITH cte1 AS
	(SELECT city_name, _before_after_5g, ROUND(AVG(ms_pct),2) AS Market_shares
	FROM fact_market_share MS 
	JOIN dim_cities DC ON
	DC.city_code = MS.city_code
	JOIN dim_date DD ON
	DD.date = MS.date
	WHERE company = 'Atliqo'
	GROUP BY city_name, _before_after_5g
	ORDER BY Market_shares DESC )
SELECT city_name, 
		MAX(CASE WHEN _before_after_5g = 'Before 5G'THEN Market_shares ELSE NULL END) AS MS_Before_5G,
        MAX(CASE WHEN _before_after_5g = 'After 5G'THEN Market_shares ELSE NULL END) AS MS_After_5G,
        ROUND(MAX(CASE WHEN _before_after_5g = 'After 5G'THEN Market_shares ELSE NULL END)-MAX(CASE WHEN _before_after_5g = 'Before 5G'THEN Market_shares ELSE NULL END),2) AS chg
FROM cte1
GROUP BY city_name ;

-- Compare metrics (revenue, ARPU, active users) for corresponding months before and after 5G (e.g., January vs. June). Calculate absolute and percentage differences.
	
WITH metrics_summary AS (
    SELECT 
        d.time_period,
        d._before_after_5g,
        SUM(f.atliqo_revenue_crores) AS total_revenue,
        ROUND(AVG(f.arpu), 2) AS avg_arpu,
        SUM(f.active_users_lakhs) AS total_active_users
    FROM 
        dim_date d
    JOIN 
        fact_atliqo_metrics f 
        ON d.date = f.date
    WHERE 
        f.company = 'Atliqo'
    GROUP BY 
        d.time_period, d._before_after_5g
),
metrics_comparison AS (
    SELECT 
        b.time_period AS month_pair,
        ROUND(b.total_revenue,2) AS before_revenue,
        ROUND(a.total_revenue,2) AS after_revenue,
        ROUND((a.total_revenue - b.total_revenue),2) AS revenue_diff,
        ROUND(((a.total_revenue - b.total_revenue) / b.total_revenue) * 100, 2) AS revenue_diff_pct,

        ROUND(b.avg_arpu,2) AS before_arpu,
        ROUND(a.avg_arpu,2) AS after_arpu,
        ROUND((a.avg_arpu - b.avg_arpu),2) AS arpu_diff,
        ROUND(((a.avg_arpu - b.avg_arpu) / b.avg_arpu) * 100, 2) AS arpu_diff_pct,

        ROUND(b.total_active_users,2) AS before_active_users,
        ROUND(a.total_active_users,2) AS after_active_users,
        ROUND((a.total_active_users - b.total_active_users),2) AS active_users_diff,
        ROUND(((a.total_active_users - b.total_active_users) / b.total_active_users) * 100, 2) AS active_users_diff_pct
    FROM 
        metrics_summary b
    JOIN 
        metrics_summary a 
        ON b.time_period = a.time_period AND b._before_after_5g = 'Before 5G' AND a._before_after_5g = 'After 5G'
)
SELECT 
    month_pair,
    before_revenue, after_revenue, revenue_diff, revenue_diff_pct,
    before_arpu, after_arpu, arpu_diff, arpu_diff_pct,
    before_active_users, after_active_users, active_users_diff, active_users_diff_pct
FROM 
    metrics_comparison;

-- List the top 5 cities where the number of unsubscribed users increased the most after 5G rollout, showing absolute and percentage change.

WITH cte1 AS
(SELECT city_name, ROUND(SUM(unsubscribed_users_lakhs),2) AS u_U, _before_after_5g 
FROM fact_atliqo_metrics AM
JOIN dim_cities DC ON
DC.city_code= AM.city_code
JOIN dim_date DD ON
DD.date = AM.date
GROUP BY city_name,_before_after_5g )
SELECT b5.city_name, b5.u_u AS Unsubscribed_users_Before_5G, a5.u_u AS Unsubscribed_users_After_5G, ROUND((a5.u_u-b5.u_u),2) AS chg, ROUND((a5.u_u-b5.u_u)/b5.u_u*100,2) AS chg_per 
FROM cte1 b5
JOIN cte1 a5 ON
b5.city_name = a5.city_name
WHERE 
b5._before_after_5g = 'Before 5G'
AND
a5._before_after_5g = 'After 5G'
ORDER BY chg_per DESC
LIMIT 5
;

-- How does Atliqo's market share compare to its competitors (Britel, DADAFONE, PIO, and Others) before and after 5G rollout?

WITH cte1 AS
	(SELECT company, _before_after_5g, ROUND(AVG(ms_pct),2) AS Market_share 
	FROM fact_market_share MS
	JOIN dim_date DD ON
	DD.date = MS.date
	GROUP BY company, _before_after_5g)
SELECT b5.company, b5.Market_share AS Market_share_before_5G, a5.Market_share AS Market_share_After_5G 
FROM cte1 b5
JOIN cte1 a5 ON
b5.company = a5.company
WHERE b5._before_after_5g = "Before 5G"
AND a5._before_after_5g = "After 5G"
ORDER BY Market_share_before_5G DESC
